{"version":3,"file":"ARRenderer.js","sourceRoot":"","sources":["../../src/three-components/ARRenderer.js"],"names":[],"mappings":"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","sourcesContent":["import {Matrix4, Object3D, PerspectiveCamera, Raycaster, Scene, Vector3, WebGLRenderer} from 'three';\n\nimport {assertIsArCandidate} from '../utils.js';\n\nimport Reticle from './Reticle.js';\nimport Shadow from './Shadow.js';\n\nconst $presentedScene = Symbol('presentedScene');\n\nconst $device = Symbol('device');\nconst $devicePromise = Symbol('devicePromise');\nconst $rafId = Symbol('rafId');\nconst $currentSession = Symbol('currentSession');\nconst $tick = Symbol('tick');\nconst $frameOfReference = Symbol('frameOfReference');\nconst $resolveCleanup = Symbol('resolveCleanup');\n\nconst $outputCanvas = Symbol('outputCanvas');\nconst $outputContext = Symbol('outputContext');\n\nconst $onWebXRFrame = Symbol('onWebXRFrame');\nconst $onOutputCanvasClick = Symbol('onOutputCanvasClick');\nconst $onFullscreenchange = Symbol('onFullscreenchange');\nconst $postSessionCleanup = Symbol('postSessionCleanup');\n\nconst matrix4 = new Matrix4();\nconst vector3 = new Vector3();\nconst originArray = new Float32Array(3);\nconst directionArray = new Float32Array(3);\n\nexport class ARRenderer {\n  /**\n   * Given an inline Renderer, construct an ARRenderer and return it\n   */\n  static fromInlineRenderer(renderer) {\n    return new ARRenderer(renderer.canvas, renderer.context);\n  }\n\n  constructor(inputCanvas, inputContext) {\n    this.renderer = null;\n\n    this.inputCanvas = inputCanvas;\n    this.inputContext = inputContext;\n\n    this.camera = new PerspectiveCamera();\n    this.camera.matrixAutoUpdate = false;\n\n    this.scene = new Scene();\n    this.dolly = new Object3D();\n    this.reticle = new Reticle(this.camera);\n\n    this.scene.add(this.reticle);\n    this.scene.add(this.dolly);\n\n    this[$outputCanvas] = null;\n    this[$outputContext] = null;\n    this[$rafId] = null;\n    this[$currentSession] = null;\n    this[$frameOfReference] = null;\n    this[$presentedScene] = null;\n    this[$resolveCleanup] = null;\n\n    this[$device] = null;\n\n    // NOTE: XRDevice is being removed\n    // @see https://github.com/immersive-web/webxr/pull/405\n    this[$devicePromise] = this.resolveDevice()\n                               .then((device) => {\n                                 return this[$device] = device;\n                               })\n                               .catch((error) => {\n                                 console.warn(error);\n                                 console.warn('Browser AR will be disabled');\n                               });\n  }\n\n  initializeRenderer() {\n    if (this.renderer != null) {\n      return;\n    }\n\n    this.renderer = new WebGLRenderer(\n        {canvas: this.inputCanvas, context: this.inputContext});\n    this.renderer.setSize(window.innerWidth, window.innerHeight);\n    this.renderer.setPixelRatio(1);\n    this.renderer.autoClear = false;\n    this.renderer.gammaOutput = true;\n    this.renderer.gammaFactor = 2.2;\n  }\n\n  async resolveDevice() {\n    assertIsArCandidate();\n\n    return await navigator.xr.requestDevice();\n  }\n\n  async resolveARSession() {\n    assertIsArCandidate();\n\n    const device = this[$device];\n\n    const session = await device.requestSession(\n        {environmentIntegration: true, outputContext: this.outputContext});\n\n    const gl = this.renderer.getContext();\n\n    await gl.setCompatibleXRDevice(device);\n    session.baseLayer = new XRWebGLLayer(session, gl, {alpha: true});\n    this.renderer.setFramebuffer(session.baseLayer.framebuffer);\n\n    return session;\n  }\n\n  /**\n   * The currently presented scene, if any\n   */\n  get presentedScene() {\n    return this[$presentedScene];\n  }\n\n  /**\n   * Resolves to true if the renderer has detected all the necessary qualities\n   * to support presentation in AR.\n   */\n  async supportsPresentation() {\n    try {\n      assertIsArCandidate();\n\n      const device = await this[$devicePromise];\n      await device.supportsSession(\n          {environmentIntegration: true, outputContext: this.outputContext});\n\n      return true;\n    } catch (error) {\n      return false;\n    }\n  }\n\n  /**\n   * Present a scene in AR\n   */\n  async present(scene) {\n    if (this.isPresenting) {\n      console.warn('Cannot present while a model is already presenting');\n      return;\n    }\n\n    scene.model.scale.set(1, 1, 1);\n    this[$presentedScene] = scene;\n\n    this.initializeRenderer();\n\n    this[$currentSession] = await this.resolveARSession();\n    this[$currentSession].addEventListener('end', () => {\n      this[$postSessionCleanup]();\n    }, {once: true});\n    this[$frameOfReference] =\n        await this[$currentSession].requestFrameOfReference('eye-level');\n\n    this[$tick]();\n\n    return this.outputCanvas;\n  }\n\n  /**\n   * If currently presenting a scene in AR, stops presentation and exits AR.\n   */\n  async stopPresenting() {\n    if (!this.isPresenting) {\n      return;\n    }\n\n    const cleanupPromise = new Promise((resolve) => {\n      this[$resolveCleanup] = resolve;\n    });\n\n    try {\n      const session = this[$currentSession];\n      this[$currentSession] = null;\n      session.cancelAnimationFrame(this[$rafId]);\n\n      await session.end();\n      await cleanupPromise;\n    } catch (error) {\n      console.warn('Error while trying to end AR session');\n      console.warn(error);\n\n      this[$postSessionCleanup]();\n    }\n  }\n\n  [$postSessionCleanup]() {\n    if (this[$presentedScene] != null) {\n      this.dolly.remove(this[$presentedScene]);\n      this[$presentedScene].skysphere.visible = true;\n      this[$presentedScene].scaleModelToFitRoom();\n    }\n\n    this[$frameOfReference] = null;\n    this[$presentedScene] = null;\n\n    if (this.outputCanvas.parentNode != null) {\n      this.outputCanvas.parentNode.removeChild(this.outputCanvas);\n    }\n\n    if (this[$resolveCleanup] != null) {\n      this[$resolveCleanup]();\n    }\n  }\n\n  /**\n   * True if a scene is currently in the process of being presented in AR\n   */\n  get isPresenting() {\n    return this[$presentedScene] != null;\n  }\n\n  get outputCanvas() {\n    if (this[$outputCanvas] == null) {\n      this[$outputCanvas] = document.createElement('canvas');\n      this[$outputCanvas].setAttribute('style', `\ndisplay: block;\nposition: absolute;\ntop: 0px;\nleft: 0px;\nwidth: 100%;\nheight: 100%;`);\n      // NOTE: Only Chrome supports Web XR right now, but eventually platforms\n      // that do not directly support any kind of pointer event (such as\n      // Hololens) might have Web XR (or its successor). In this case, we would\n      // want to rely on XRInputSource and \"select\" XRInputSourceEvent (or their\n      // successors) to abstract these input details for us.\n      // @see https://immersive-web.github.io/webxr/#xrinputsource-interface\n      this[$outputCanvas].addEventListener(\n          'click', () => this[$onOutputCanvasClick]());\n    }\n\n    return this[$outputCanvas];\n  }\n\n  get outputContext() {\n    if (this[$outputContext] == null) {\n      this[$outputContext] = this.outputCanvas.getContext('xrpresent');\n    }\n\n    return this[$outputContext];\n  }\n\n\n  async[$onOutputCanvasClick]() {\n    if (this[$currentSession] == null) {\n      return;\n    }\n\n    if (this.raycaster == null) {\n      this.raycaster = new Raycaster();\n    }\n\n    const presentedScene = this[$presentedScene];\n\n    // NOTE: Currently rays will be cast from the middle of the screen.\n    // Eventually we might use input coordinates for this.\n    this.raycaster.setFromCamera({x: 0, y: 0}, this.camera);\n\n    const ray = this.raycaster.ray;\n    originArray.set(ray.origin.toArray());\n    directionArray.set(ray.direction.toArray());\n    const hits = await this[$currentSession].requestHitTest(\n        originArray, directionArray, this[$frameOfReference]);\n    if (hits.length) {\n      const hit = hits[0];\n      const hitMatrix = matrix4.fromArray(hit.hitMatrix);\n\n      this.dolly.position.setFromMatrixPosition(hitMatrix);\n      this.dolly.rotation.set(0, -presentedScene.pivot.rotation.y, 0);\n\n      presentedScene.skysphere.visible = false;\n      this.dolly.add(presentedScene);\n    }\n  }\n\n  [$tick]() {\n    this[$rafId] = this[$currentSession].requestAnimationFrame(\n        (time, frame) => this[$onWebXRFrame](time, frame));\n  }\n\n  [$onWebXRFrame](time, frame) {\n    const {session} = frame;\n    const pose = frame.getDevicePose(this[$frameOfReference]);\n\n    this.reticle.update(this[$currentSession], this[$frameOfReference]);\n\n    // TODO: Notify external observers of tick\n    // TODO: Note that reticle may be \"stabilized\"\n\n    this[$tick]();\n\n    if (pose == null) {\n      return;\n    }\n\n    for (const view of frame.views) {\n      const viewport = session.baseLayer.getViewport(view);\n      this.renderer.setViewport(0, 0, viewport.width, viewport.height);\n      this.renderer.setSize(viewport.width, viewport.height, false);\n      this.camera.projectionMatrix.fromArray(view.projectionMatrix);\n      const viewMatrix = matrix4.fromArray(pose.getViewMatrix(view));\n\n      this.camera.matrix.getInverse(viewMatrix);\n      this.camera.updateMatrixWorld(true);\n      // NOTE: Clearing depth caused issues on Samsung devices\n      // @see https://github.com/googlecodelabs/ar-with-webxr/issues/8\n      // this.renderer.clearDepth();\n      this.renderer.render(this.scene, this.camera);\n    }\n  }\n}\n"]}